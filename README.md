# BTHome THB2, BTH01, TH-05
Custom firmware for Tuya [THB2](https://pvvx.github.io/THB2), [BTH01](https://pvvx.github.io/BTH01/), [TH-05](https://pvvx.github.io/TH-05). 

* Проект в начальной стадии разработки, до появления функционального OTA.

* Тестовый [PHY62x2BTHome.html](https://pvvx.github.io/THB2/web/PHY62x2BTHome.html)

Прошивка для THB2 (файл bin\BOOT_THB2_v0x.hex). 

Прошивка для BTH01 (файл bin\BOOT_BTH01_v0x.hex). 

Прошивка для TH05 (файл bin\BOOT_TH05_v0x.hex). 

Весрии 0.x - это прошивки для тестов.

Пока номер прошивки не 1.х или выше, это тестовые прошивки и многие вещи в них не работают или не доделаны.

Нормальное ОТА будет от версии 1.0.

Если прошитая версия работает, то менять ее нет необходимости до выхода v1.0.
Только к ней будут правильно работать настройки и OTA в [PHY62x2BTHome.html](https://pvvx.github.io/THB2/web/PHY62x2BTHome.html).

## Основные характеристики:

* Интервал BLE рекламы в формате BTHome v2 равен 5 секундам.
* Опрос датчика влажности и температуры производится  каждый второй интервал BLE рекламы - период 10 секунд.
* Измерение напряжения батареи производится каждую минуту.
* Кнопка используется для быстрого подключения к старым BT-адаптерам. Нажатие кнопки переключает интервал BLE рекламы на более короткий период. Действие продолжится 60 секунд, затем интервал восстановится.
* Измеренное среднее потребление от источника в 3.3В при сканировании термометров THB2 и BTH01 в пассивном режиме составляет до 7.9 мкА. Для TH-05 среднее потребление около 21 мкА - таков ток установленных компонентов. Но это меньше, чем потребление только в спящем режиме у оригинальной прошивки от Tuya (23 мкА)(!).


## Прошивка:

Прошить устройство возможно через USB-COM адаптер с выходами на 3.3В:

1. Соединить GND, TX, RX, RTS–RESET, VCC (+3.3B).
2. Запустить:
```
python3 rdwr_phy62x2.py -p COM11 -e -r wh BOOT_xxx_vxx.hex
```
3. Прошивка зашита. Устройство работает.

Дополнительно:

* Для предварительного стирания всей Flash используйте опцию `-a`.

* Для предварительного стирания рабочей области Flash используйте опцию `-e`.

## Сохранение оригинальной прошивки.

1. Соединить GND, TX, RX, RTS–RESET, VCC (+3.3B).
2. Запустить:
```
python3 rdwr_phy62x2.py -p COM11 -r rc 0x11000000 0x80000 ff_thb2.bin
```
3. Полученный файл ff_thb2.bin сохранить.

## Восстановление оригинальной прошивки.

1. Взять сохраненный файл ff_thb2.bin оригинальной прошивки.
2. Соединить GND, TX, RX, RTS–RESET, VCC (+3.3B).
3. Запустить:
```
python3 rdwr_phy62x2.py -p COM11 -b 1000000 -r we 0 ff_thb2.bin
```
Не все адаптеры USB-COM поддерживают 1Mbit. Тогда удалите опцию `-b 1000000` или выберите другой Baud rate.

4. Прошивка зашита. Устройство работает.


## Сборка прошивки.

Для сборки прошивки используется GNU Arm Embedded Toolchain.

Для работы в Eclipce используете импорт проекта и установите toolchain.path.

Дополнительная информация по чипам [PHY62xx](https://github.com/pvvx/PHY62x2). 
